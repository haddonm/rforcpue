---
title: "Eastern ZOne Abalone Docket CPUE"
author: "Malcolm Haddon"
date: "`r format(Sys.time(), '%d&period; %B %Y')`"
output: 
  html_document:
    df_print: paged
    fig_caption: yes
    number_sections: yes
    toc: yes
    toc_depth: 4
  pdf_document:
    fig_caption: yes
    includes:
      in_header: C:\Users\Malcolm\Dropbox\abalone\abalone\ab_cpue\header.tex
    keep_tex: yes
    number_sections: yes
    toc: yes  
    toc_depth: 4
  word_document:
    reference_docx: C:\Users\Malcolm\Dropbox\AbSpatial\MH\wordreferencestyle.docx
    toc: true
    fig_caption: true
---


```{r setup, include = FALSE}
#       in_header: C:\Users\Malcolm\Dropbox\AbSpatial\MH\header.tex
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE,
	comment = "#",
	fig.align = 'center')
  options(knitr.kable.NA = "",
          knitr.table.format = "pandoc")
  
options(tinytex.verbose = TRUE)  # change this to suit


options(show.signif.stars = FALSE,
        stringsAsFactors = FALSE,
        max.print = 50000,
        width = 240)

if (dir.exists("C:/Users/Malcolm/Dropbox")) {
   ddir <- "C:/Users/Malcolm/Dropbox"
  } else {
   ddir <- "C:/Users/User/Dropbox"
}
datadir <- paste0(ddir,"/","AbaloneData")

library(rutilsMH)  # https://github.com/haddonm
library(diagrams)  # https://github.com/haddonm
library(abspatR)
library(sp)
library(rgdal)
library(knitr)
suppressMessages(library(r4maps)) # https://github.com/haddonm
library(captioner)
library(rforcpue)    # https://github.com/haddonm

fig_nums <- captioner(prefix = "Figure")
equ_nums <- captioner(prefix = "Equ ")
yr1 <- 1992
lastyr <- 2019
years <- yr1:lastyr
nyrs <- 7
fign <- 0
tabn <- 0
occurbl <- NULL
occurgl <- NULL
occurblcatch <- NULL
occurglcatch <- NULL

setHook("plot.new",
        list(las = function() par(las = 0),
             pch = function() par(pch = 16),
             fam = function() par(family = "serif")),
        "append")

```

# Introduction

## Objectives of this Document

```{r "t01", echo=TRUE}
# Get data -----------------------------------------------------------
datafile <- paste0(datadir,"/CatchEffortData_2020-02-11.RData")
load(datafile)
ab <- abCEbl
columns <- colnames(ab)  # simplify the column names
replace <- c("diver_id","fishing_date","fishyear","fishmonth","blockno",
             "subblockno","newzone","totalcatch","propblip",
             "entitlement.num","blprop.factor")
repwith <- c("diver","date","year","month","block","subblock","zone",
             "totC","pblip","entitle","percbl")
colnames(ab) <- tidynames(columns,replace,repwith)
pick <- which(ab[,"year"] > lastyr) # lastyr set to 2019 to remove 
ab <- droplevels(ab[-pick,])        # a few 2020 records

# Get the catch by zone ----------------------------------------------
cbz <- tapply(ab$catch,list(ab$year,ab$zone),sum,na.rm=TRUE)/1000
kable(cbz,digits=c(3,3,3,3))
tacs <- read.csv(file="C:/Users/User/Dropbox/rcode2/abcpue/data-raw/abaloneTAC.csv",
                 header=TRUE)

# look for outliers --------------------------------------------------
pickrec <- which((ab$hours > 0) & (ab$hours < 48) & (ab$catch > 0))
label <- paste0("Hours of Effort from ",length(pickrec)," records")
ab2 <- droplevels(ab[pickrec,])
pickz <- which(ab$catch == 0)
ab0 <- droplevels(ab[pickz,])
numdiv <- as.numeric(table(ab0$numdivers))
# make final selection
pickrec2 <- which((ab$hours > 0) & (ab$hours < 20) &
                 (ab$catch > 0) & (ab$catch < 4000) &
                 (ab$cpue < 1100) & (ab$zone == "E"))
ab1 <- droplevels(ab[pickrec2,])
ab3 <- droplevels(ab[-pickrec2,])
# remove divers present only in one year across whole state
```


```{r fig.width=6, fig.height=5}

plotprep(width=7,height=5,newdev=FALSE)
parset(plots=c(2,2),margin=c(0.45,0.45,0.05,0.1))
label <- colnames(cbz)
labtac <- c("BS","E","N","TotalW")
yrs <- as.numeric(rownames(cbz))
for (i in 1:4) { # i=1
  ymax <- getmax(c(cbz[,i],tacs[,labtac[i]]))
  plot(yrs,cbz[,i],type="l",lwd=2,ylab=label[i],ylim=c(0,ymax),
       panel.first=grid(),yaxs="i")
  abline(v=2000,lwd=1,col=1,lty=2)
  lines(tacs[,"year"],tacs[,labtac[i]],lwd=2,col=2)
}


```





```{r fig.width=6, fig.height=6}
# tabulate blocks --------------------------
cbby <- tapply(ab1$catch,list(ab1$year,ab1$block),sum,na.rm=T)/1000
aav <- numeric(19)
for (i in 1:19) aav[i] <- getaav(cbby[,i])
yrs <- as.numeric(rownames(cbby))
label <- colnames(cbby)
totC <- colSums(cbby,na.rm=TRUE)
cbz <- tapply(ab$catch,list(ab$year,ab$zone),sum,na.rm=TRUE)/1000
yrtotC <- cbz[,"E"]
parset(plots=c(5,4),margin=c(0.25,0.35,0.1,0.05))
for (i in 1:19) {
  ymax <- getmax(cbby[,i])
  plot(yrs,cbby[,i],type="l",lwd=2,ylim=c(0,ymax),panel.first=grid(),
       ylab=label[i],xlab="")
  text(2009,0.9*ymax,round(totC[i],1),cex=0.9,pos=4)
  text(1998,0.9*ymax,round(aav[i],3),cex=0.9,pos=4)
}
ymax <- getmax(yrtotC)
plot(yrs,yrtotC,type="l",lwd=2,ylim=c(0,ymax),panel.first=grid(),
     ylab="Zone Total",xlab="")
#text(1998,0.9*ymax,round(aav[i],3),cex=0.9,pos=4)
```

Various blocks have very small catches and are even lacking reported  catches in some years. Those blocks can be omitted from the following analyses. Hence we will omit the following from the comparative analyses, blocks 15, 18, 25, 26, 30. Even though block 19 has reported catches in each year, in some years there ar eless than 10 records and less than 1 tonne of catch, so it too has been removed from consideration. 

```{r}
# Document some of the propoerties of each block.
blk <- c(13,14,16,17,20,21,22,23,24,27,28,29,31)
pick <- which(ab1$block %in% blk)
ab2 <- droplevels(ab1[pick,])
records <- as.numeric(table(ab2$block))
catch <- tapply(ab2$catch,ab2$block,sum,na.rm=TRUE)/1000
rbbd <- as.matrix(table(ab2$diver,ab2$block))
dbb <- apply(rbbd,2,countgtzero)
out <- cbind(blk,round(catch,3),records,dbb)
colnames(out) <- c("block","catch","records","divers")
out
```

```{r}
# records by block by year
table(ab2$year,ab2$block)
```

Many of the more northern blocks exhibit greatly reduced numbers of observations nd much lower catches in the last two to three years. For this reason, any analysis of catch-rates (cpue) needs to be circumspect about drawing any conclusions concerning those most recent years.

```{r}
# catch by block by year
cbby <- tapply(ab2$catch,list(ab2$year,ab2$block),sum,na.rm=TRUE)/1000
round(cbby,1)
```

Plotting these catch values relative to one another:

```{r fig.width=6, fig.height=6}
parset(plots=c(3,1))
ymax <- getmax(yrtotC)
yrs <- 1992:2019
plot(yrs,yrtotC,type="l",ylim=c(0,ymax),yaxs="i",panel.first=grid(),
     ylab="Zone Total")
ymax <- getmax(cbby[,1])
plot(yrs,cbby[,1],type="l",ylim=c(0,ymax),yaxs="i",panel.first=grid(),
     ylab="Block 13")
ymax <- getmax(cbby[,2:13])
plot(yrs,cbby[,2],type="l",ylim=c(0,ymax),yaxs="i",panel.first=grid(),
     ylab="The Rest")
for (i in 3:13) lines(yrs,cbby[,i],col=i-1)
```



First we can conduct a whole of zone standardization.

```{r }
splabel <- "Eastern Zone Blacklip"
labelM <- c("year","diver","take_vessel","month","ports","block")
ab3 <- makecategorical(labelM,ab2) # First use divers >1 year
mods <- makemodels(labelM)
model1 <- standLM(mods,ab3,splabel,console=FALSE) #only use diver >1yr
```

```{r fig.width=6, fig.height=5}
geom <- geomean(ab2$cpue)
catcht <- tapply(ab$catch[ab$zone=="E"],ab$year[ab$zone=="E"],sum,na.rm=TRUE)/1000
plotstand(model1,bars=TRUE,geo=geom,catch=yrtotC)

```


Then repeat this for each of the 13 main blocks

```{r}
blk <- c(13,14,16,17,20,21,22,23,24,27,28,29,31)
allresult <- matrix(0,nrow=28,ncol=13,dimnames=list(1992:2019,blk))
for (i in 1:13) {
  pick <- which(ab2$block == blk[i])
  ab3 <- droplevels(ab2[pick,])
  spslabel <- paste0("block",blk[i])
  labelM <- c("year","diver","take_vessel","ports","month")
  ab4 <- makecategorical(labelM,ab3) # First use divers >1 year
  mods <- makemodels(labelM)
  model2 <- standLM(mods,ab4,splabel,console=FALSE) #only use diver >1yr
  allresult[,i] <- model2$Results[,model2$Optimum]
  cat(blk[i],model2$WhichM[6,],"\n")
}

```


```{r fig.width=6, fig.height=5}
ymax <- getmax(allresult)
yrs <- 1992:2019
plot(yrs,model1$Results[,model1$Optimum],type="l",lwd=2,ylim=c(0,ymax),
     panel.first=grid())
for (i in 1:13) lines(yrs,allresult[,i],col=i)


```



```{r fig.width=6, fig.height=4}
# analyse a particular block
pick <- which(ab2$block == 29)
  ab3 <- droplevels(ab2[pick,])
  spslabel <- paste0("block",blk[i])
  labelM <- c("year","diver","take_vessel","month","ports")
  ab4 <- makecategorical(labelM,ab3) # First use divers >1 year
  mods <- makemodels(labelM)
  model2 <- standLM(mods,ab4,splabel,console=FALSE) #only use diver >1yr
  round(model2$WhichM,4)

```



```{r fig.width=6, fig.height=5}
geom <- geomean(ab3$cpue)
catcht <- tapply(ab3$catch,ab3$year,sum,na.rm=TRUE)/1000
plotstand(model2,bars=TRUE,geo=geom,catch=catcht)


```




```{r fig.width=6, fig.height=7}
impactplot(model2,mult=3)

```


```{r fig.width=6, fig.height=7}
parset(plots=c(7,4),margin=c(0.3,0.4,0.05,0.05))
for (yr in 1992:2019) {
  pick <- which(ab3$year == yr)
  hist(ab3$cpue[pick],breaks=seq(0.0,500,20),col=2,main=yr,xlab="")
}

```










