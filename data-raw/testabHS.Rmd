---
title: "Testing the current blacklip abalone harvest strategy."
author: "Craig Mundy and Malcolm Haddon"
date: "`r format(Sys.time(), '%d&period; %B %Y')`"
output: 
    word_document:
      reference_docx:  C:\Users\User\Dropbox\A_Book\book\trialreferencestyle.docx
      toc: true
      toc_depth: 3
      fig_caption: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE)

options(knitr.kable.NA = "",
        knitr.table.format = "pandoc")

if (dir.exists("C:/Users/Malcolm/Dropbox")) {
  ddir <- "C:/Users/Malcolm/Dropbox"
} else {
  ddir <- "C:/Users/User/Dropbox"
}
datadir <- paste0(ddir,"/","AbaloneData")

wkdir <- "./../../manuscripts/CurrentHS/"
rawdir <- paste0(ddir,"/rcode2/abcpue/data-raw/")

options("show.signif.stars"=FALSE,"stringsAsFactors"=FALSE,
        "max.print"=50000,"width"=240)

library(rutilsMH)
suppressPackageStartupMessages(library(knitr))
library(captioner)
library(abcpue)    # https://github.com/haddonm

tab_nums <- captioner(prefix = "Table")
fig_nums <- captioner(prefix = "Figure")
equ_nums <- captioner(prefix = "Equ.")

#source(file.path("./../../A_Book/book/Rcpp_functions.R"))

```



# Performance of the current Tasmanian abalone harvest strategy

Craig Mundy$^{1}$ and Malcolm Haddon$^{1,2}$

1. Institute of Marine and Antarctic Science, University of Tasmania, P.O. Box 49, Hobart, Tasmania, Australia

2. CSIRO Oceans and Atmosphere, GPO Box 1538, Hobart, TAS 7001, Australia


# Abstract



# Objective(s)



# Introduction

The Tasmanian blacklip abalone fishery (_Haliotis rubra_) is spatially managed using a collection of quota zones, each made up of a set of statistical blocks along the coastline. Each year decisions are made concerning what catch can be expected from each block and the sum is proposed as the recommended biological catch (RBC) which, when finalized as a Total Allowable Catch (TAC), which may differ from the RBC, is allocated as individual transferable quota to the quota holders. 

Prior to 2015 the block catch expectations were derived within a co-management framework where available data on catches, catch-rates, and size-composition of catch from the fishery were examined and decisions made regarding the catch levels deemed reasonable for each block. From 2015, a more formal harvest strategy, developed over the previous five years, was applied in parallel to the less formal process, and from 2018, after minor tuning, was applied and used as the basis for the formal advice from the agency tasked with providing management advice to the Tasmanian State government. Adherence to the TAC and compliance more generally, is focussed at a quota-zone level despite the TAC being derived at a spatial resolution of the statistical blocks. Adherence to the expected catches from each block is mostly voluntary, with industry agreeing to statistical block closures once the agreed catch from a block is reached. However, there is excess fishing power in the dive fleet, and it takes between one and two weeks to close a block, so some deviations are expected. Unfortunately, the performance of the harvest strategy may be negatively impacted if such deviations are ever large as too much would come from some blocks and not enough from others. This can be examined now that there are five yearsâ€™ experience in operating the harvest strategy. Such a comparison of the expectations with what, in fact, happened will be informative about the strategies effectiveness and should identify any weaknesses and strengths.


# Methods

We need to obtain unambivalent tables of the TACs for the main zones, the expected catch by block/zone for the main zones (or all zones), and the reported catches by block/zone. The docket datasets do not contain records for the Central West Zone and the Bass Strait zone catches seem double the TAC.

We also need clear statements of the management frameworks and modifications over the period of what we can call the trial. Thus, the details of the shortening of the time required between notification and closing a block need clarification.

# Results

The data.frame _ab_ contains all available docket data with no filtering except to select the years to be considered (we omit a few 2020 records). Total catches for any spatial configuration should use _ab_, but when estimating the mean cpue by year it is first necessary to do some data selection to avoid outliers and strange data.

```{r}
# First get the data
datafile <- paste0(datadir,"/CatchEffortData_2020-06-15.RData")
load(datafile)
ab <- abCEbl # simplify, simplify, simplify! Don't you just mean simplify?
columns <- colnames(ab) 
replace <- c("diver_id","fishing_date","fishyear","fishmonth","blockno",
             "subblockno","newzone","totalcatch","propblip",
             "entitlement.num","blprop.factor")
repwith <- c("diver","date","year","month","block","subblock","zone",
             "totC","pblip","entitle","percbl")
colnames(ab) <- tidynames(columns,replace,repwith)
pick <- which(ab[,"year"] > 2019) # lastyr set to 2019 to remove
ab <- droplevels(ab[-pick,])        # a few 2020 records

```

## Reported Catch vs TAC

```{r}
# catch by zone by year ----------------------------------------------
cbz <- tapply(ab$catch,list(ab$year,ab$zone),sum,na.rm=TRUE)/1000
label <- colnames(cbz)
cbzy <- cbind(as.numeric(rownames(cbz)),cbz)
colnames(cbzy) <- c("year",label)
kable(halftable(cbzy,yearcol="year",subdiv=2),digits=c(3,3,3,3,3,3,3,3))
tacs <- read.csv(file=paste0(rawdir,"abaloneTAC.csv"),header=TRUE)
```

```{r fig.width=6, fig.height=5}
plotprep(width=7,height=5,newdev=FALSE)
parset(plots=c(2,2),margin=c(0.45,0.45,0.05,0.1))
label <- colnames(cbz)
labtac <- c("BS","E","N","TotalW")
yrs <- as.numeric(rownames(cbz))
for (i in 1:4) { # i=1
  ymax <- getmax(c(cbz[,i],tacs[,labtac[i]]))
  plot(yrs,cbz[,i],type="l",lwd=2,ylab=label[i],ylim=c(0,ymax),
       panel.first=grid(),yaxs="i")
  abline(v=2000,lwd=1,col=1,lty=2)
  lines(tacs[,"year"],tacs[,labtac[i]],lwd=2,col=2)
}

```

In _CatchEffortData_2020-02-11.RData_, the _abCEbl_ data (designated _ab_ here) only includes zones BS, E, N, and W (ie no CW, damn nuisance though it is). The eastern zone obviously adheres very closely to the TAC. The northern zone less so, but recognizably close. The Bass Strait zone is very odd, and so is the western zone (which I am guessing is being messed about by the BS/N zones, specially in the early years). Whatever the case, for now we can proceeed with the eastern zone data but the rest need some clarification.

## Expected Catches by Block

At the FRAG, each year, decisions are made regarding the expected catches to be taken from each block. These can be tabulated from records kept during the meetings. We can thus examine the distribution of expected catches across the statistical blocks within the Eastern quota zone. The five years of data include 2015 and 2016 during which no changes were made to the recommended expected catches.


```{r}
rbc <- read.csv(file=paste0(rawdir,"blacklip_FRAG.csv"),header=TRUE)

zone <- "E"
pick <- which((rbc$zone == zone) & (rbc$year < 2020))
zrbc <- droplevels(rbc[pick,])
out <- tapply(zrbc$allocC,list(zrbc$block,zrbc$year),sum,na.rm=TRUE)
outS <- rbind(out,colSums(out))
kable(outS,digits=c(1,1,1,1))

```

It is clear that the eastern zone fishery is now highly dependent upon the productivity of the eastern part of block 13, which includes the Acteaon Islands. It is also clear that over the five year period from 2015 - 2019 the RBC has declined so that the 2019 recommended catch is only 47.6% of that in 2015. An examination of the standardized cpue for the eastern zone along with the associated total catch provides sufficient explanation for why such large changes occurred.

## Total Catch

Before selecting what data constitute plausible values we first need to limit the data-set to the eastern zone only. The range of effort (as hours) in the data.frame _ab_ extends from 0.0 to 1320.17. The latter is clearly an error and choices need to be made as to what consistitutes the minimum degree of data selection that one can apply to remove implausible data. Details of how the data selection criteria were chosen are given in the supplementary material.


```{r}
# make selection using criteria described in supplementary material
pickrec2 <- which((ab$hours > 0) & (ab$hours < 12) &
                  (ab$catch > 0) & (ab$catch < 1300) &
                  (ab$cpue < 340) & (ab$zone == "E"))
ab1 <- droplevels(ab[pickrec2,])
ab3 <- droplevels(ab[-pickrec2,])
```

### Catch per Block


```{r fig.width=6, fig.height=6}
# tabulate blocks --------------------------
cbby <- tapply(ab1$catch,list(ab1$year,ab1$block),sum,na.rm=T)/1000
cebby <- tapply(ab1$cpue,list(ab1$year,ab1$block),geomean) 
numb <- ncol(cbby)
aav <- numeric(numb)
for (i in 1:numb) aav[i] <- getaav(cbby[,i])
yrs <- as.numeric(rownames(cbby))
label <- colnames(cbby)
totC <- colSums(cbby,na.rm=TRUE)
cbz <- tapply(ab$catch,list(ab$year,ab$zone),sum,na.rm=TRUE)/1000
yrtotC <- cbz[,"E"]
parset(plots=c(5,4),margin=c(0.25,0.35,0.05,0.05))
for (i in 1:numb) {
  ymax <- getmax(cbby[,i])
  plot(yrs,cbby[,i],type="l",lwd=2,ylim=c(0,ymax),panel.first=grid(),
       ylab=label[i],xlab="")
  text(2009,0.9*ymax,round(totC[i],1),cex=0.9,pos=4)
  text(1998,0.9*ymax,round(aav[i],3),cex=0.9,pos=4)
}
ymax <- getmax(yrtotC)
plot(yrs,yrtotC,type="l",lwd=2,ylim=c(0,ymax),panel.first=grid(),
     ylab="Zone Total",xlab="")
text(2009,0.9*ymax,round(getaav(yrtotC),3),cex=0.9,pos=4)
```

Note well that the y-axes vary greatly between blocks. The numbers on each plot represent the annual absolute variability in catch and the total catch (tonnes) in each block. In the Zone Total plot only tyhe aav is shown; it is the lowest of all, illustrating that the variation among blocks cancels itself out to a large degree across the zone. Across the zone the catches between years are relatively smooth but within some individual blocks the variation is extreme. In the northern blocks from block 23 northward, there have been extreme catch events where the catches more than doubled over very short periods followed by declines. Some blocks appear to have never recovered from such declines (26, 27, 28, and 30). In amongst these changes in catch levels ther have also been changes to the legal minimum length which was only 132mm up until it was increased to 136mm in 2002, and 138mm in 2006. Although in block 31 (31A) the LML went the other way moving to 132 from 138 in 2010, there was also management encouragement to move ctach into 31 in subsequent years. 

```{r fig.width=6, fig.height=5}
blk <- "31"
cbby <- tapply(ab1$catch,list(ab1$year,ab1$block),sum,na.rm=T)/1000
cebby <- tapply(ab1$cpue,list(ab1$year,ab1$block),geomean) 
yrs <- as.numeric(rownames(cbby))
parset(plots=c(2,1),margin=c(0.25,0.35,0.05,0.05))
ymax <- getmax(cbby[,blk])
plot(yrs,cbby[,blk],type="l",lwd=2,ylim=c(0,ymax),panel.first=grid(),
       ylab=paste0("Catch_",blk),xlab="",yaxs="i")
ymax <- getmax(cebby[,blk])
plot(yrs,cebby[,blk],type="l",lwd=2,ylim=c(0,ymax),panel.first=grid(),
       ylab=paste0("CPUE_",blk),xlab="",yaxs="i")


```


## Zone-Wide CPUE

An important factor in any abalone fishery's cpue is the collection of divers doing the fishing. If we conduct a simple linear model using log-normal residual errors on the cpue then if a diver only fishes for a single year their influence on the general trend in cpue is minimal. We can identify in how many years a diver reports catches in the eastern zone and include this for each diver in the _ab1_ data.frame.

```{r fig.width=6, fig.height=3}
# find those divers who only fished for a single year
cbd <- tapply(ab1$catch,list(ab1$diver,ab1$year),sum,na.rm=TRUE)/1000
numyr <- apply(cbd,1,countgtzero)
divers <- as.numeric(names(numyr))
numd <- length(divers)
ab1$count <- NA
for (i in 1:numd) {
  pick <- which(ab1$diver == divers[i])
  ab1$count[pick] <- numyr[i]              
}
parset()
outh <- inthist(numyr,col=2,border=3,width=0.9,xlabel="Years Fished",
                ylabel="Number of Divers")
```

Which illustrates that between 1992 to 2019, 33 divers only fished for a single year. 

We can now apply a standardization across the whole zone both with and without single year divers. As we saw in teh plot of catch by block above, some blocks (15, 18, 19, 25, 26, and 30) either have some years with no catches or always have low catches, or both. These are also omitted from the whole of zone view. This means we are only considering the 13 blocks 13, 14, 16, 17, 20, 21, 22, 23, 24, 27, 28, 29, and 31.


```{r }
blk <- c(13,14,16,17,20,21,22,23,24,27,28,29,31)
pick <- which(ab1$block %in% blk)
ab2 <- droplevels(ab1[pick,])
splabel <- "Eastern Zone Blacklip" # with 83000 records this takes time
labelM <- c("year","diver","take_vessel","month","ports","block")
pick <- which (ab2$count > 1)
ab3 <- makecategorical(labelM,ab2[pick,]) # First use divers >1 year
mods <- makemodels(labelM)
model1 <- standLM(mods,ab3,splabel,console=TRUE) 
```

The optimum model is essentially coincident when all divers are used or only those who have fished for more than 1 year. This is not surprising given that removing those 33 divers only removed 219 records out of 82102 records, and only 50.57t out of 22853.14t.

```{r fig.width=6, fig.height=5}
geom <- geomean(ab2$cpue)
plotstand(model1,bars=TRUE,geo=geom,catch=yrtotC)
#lines(1992:2019,model2$Results[,model2$Optimum]*geom,lwd=1,col=5)
```


This is an appalling plot in so many ways!!!

From 1992 to 1998 the cpue increases and so do the catches until there was 1500t being taken from a TAC of 2520t (which included both blacklip and greenlip), so 59.5% of the total came from the east coast. From 1998 to 2002 the cpue declined 42% from an average of about 87kg/hr to only about 51kg/hr. This also led to a decline in the reported catches from 1501t down to 848t. The east and west zones were introduced in 2000 with a major objective of re-distributing catch from the east coast to the west.  

# Discussion

Clearly one lesson is that the scales of assessment need to be small but when matched with large scale management we can still end up with problems deriving from spatial heterogeneity in abundance and availability. 

The difference between availability and abundance in abalone needs more clarity.



# References



# Supplementary Material

99.957% of all records (84101/84137) reported 12 hours or less of effort, while 99.976% of all records reported 1300kg or less for their catch (even though one records reported 3200kg). In addition, there were 120 records reporting 0.0 hours of effort, and 55 records (out of 84137) reported 0.0 catch. When estimating cpue these too need to be removed.


```{r fig.width=6, fig.height=4.0}
parset(plots=c(2,2),margin=c(0.3,0.35,0.05,0.1))
oute <- hist(ab1$hours,breaks=30,col=2,main="hours",xlab="")
outc <- hist(ab1$catch,breaks=30,col=2,main="catch",xlab="")
pick <- which(ab1$hours < 12)
oute2 <- hist(ab1$hours[pick],breaks=24,col=2,main="hours",xlab="")
pick <- which(ab1$catch < 1300)
outc2 <- hist(ab1$catch[pick],breaks=26,col=2,main="catch",xlab="")

```

```{r fig.width=5, fig.height=2.75}
pick <- which((ab1$hours > 0) & (ab1$hours < 12) &
              (ab1$catch > 0) & (ab1$catch < 1300))
ab2 <- ab1[pick,] #  removes 164 records
 
parset()
outce <- hist(ab2$cpue,breaks=30,col=2,main="cpue",xlab="")
```


```{r}
cpue <- cbind(outce$counts,cumsum(outce$counts),cumsum(outce$counts)/83973)
rownames(cpue) <- outce$mids+10
colnames(cpue) <- c("count","cumsum","proportion")
cpue
```

Suggests that 99.9786% of records are retained if we place an upper limit of 340 on the cpue, despite the maximum value reported being 780kg/hr.

```{r}
tottac <- read.csv(file=paste0(rawdir,"total_TAC.csv"),header=TRUE)
totC <- rowSums(cbz,na.rm=TRUE)
blTAC=tottac[,"blTAC"]
diff <- c(rep(NA,8),blTAC[9:28]-totC[9:28])
eastcat <- cbind(cbz,totC=totC,blTAC=blTAC,diff=diff)
kable(eastcat,digits=c(3,3,3,3,3,1,3))
```

